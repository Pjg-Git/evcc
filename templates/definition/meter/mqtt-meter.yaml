template: mqtt-meter
description: 
  de: MQTT Strommessgerät
  en: MQTT Meter
generic: true
requirements:
  mqtt: true
params:
- name: usage
  choice: [ "grid", "pv", "charge", "battery" ]
- name: topicpower
  description:
    de: MQTT Topic für die Leistung (W)
    en: MQTT Topic for power (W)
  required: true
- name: scalepower
  description:
    de: Skalierung der Leistungswerte
    en: Scaling of the power value
  default: 1
  help:
    de: Die Leistung wird in Watt erwartet. Falls z.b. kW geliefert wird, kann dies hier mit dem Wert 1000 angepasst werden
    en: Power is expected to be provided in Watt. If it is provided in kW instead, set this value to 1000 to correct it
- name: topicenergy
  description:
    de: MQTT Topic für Energiemenge (Wh)
    en: MQTT Topic for energy (Wh)
- name: scaleenergy
  dependencies:
    - name: topicenergy
      check: notempty
  description:
    de: Skalierung der Energiement
    en: Scaling of the energy value
  default: 1
  help:
    de: Die Energiemenge wird in kWh erwartet. Falls z.b. Wh geliefert wird, kann dies hier mit dem Wert 0.001 angepasst werden
    en: Power is expected to be provided in kWh. If it is provided in Wh instead, set this value to 0.001 to correct it
- name: topicsoc
  description:
    de: MQTT Topic für den SoC der Batterie (%)
    en: MQTT Topic for battery SoC (%)
  dependencies:
    - name: usage
      check: equal
      value: battery
- name: topiccurrentp1
  description:
    de: MQTT Topic Stromstärke (A) Phase 1
    en: MQTT Topic Amperage (A) phase 1
- name: topiccurrentp2
  description:
    de: MQTT Topic Stromstärke (A) Phase 2
    en: MQTT Topic Amperage (A) phase 2
  dependencies:
    - name: topiccurrentp1
      check: notempty
- name: topiccurrentp3
  description:
    de: MQTT Topic Stromstärke (A) Phase 3
    en: MQTT Topic Amperage (A) phase 3
  dependencies:
    - name: topiccurrentp3
      check: notempty
- name: timeout
  default: 30
  help:
    de: Akzeptiere keine Daten die älter als dieser Wert in Sekunden ist 
    en: Don't accept values older than this value in seconds
render: |
  type: custom
  power:
    source: mqtt
    topic: {{ .topicpower }}
    scale: {{ .scalepower }}
    timeout: {{ .timeout }}
  {{- if ne .topicenergy "" }}
  energy:
    source: mqtt
    topic: {{ .topicenergy }}
    scale: {{ .scaleenergy }}
    timeout: {{ .timeout }}
  {{- end -}}
  {{- if eq .usage "battery" }}
  soc:
    source: mqtt
    topic: {{ .topicsoc }}
    timeout: {{ .timeout }}
  {{- end -}}
  {{- if ne .topiccurrentp1 "" }}
  currents:
    - source: mqtt
      topic: {{ .topiccurrentp1 }}
      timeout: {{ .timeout }}
  {{- if ne .topiccurrentp2 "" }}
    - source: mqtt
      topic: {{ .topiccurrentp2 }}
      timeout: {{ .timeout }}
  {{- end -}}
  {{- if ne .topiccurrentp3 "" }}
    - source: mqtt
      topic: {{ .topiccurrentp3 }}
      timeout: {{ .timeout }}
  {{- end -}}
  {{- end -}}
